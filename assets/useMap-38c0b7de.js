import{u as k,A as G}from"./index-86a435be.js";import{c as L,q as S,t as I,r as O}from"./index-8e4d02bc.js";function C(i,m){return(m&&i[m])!==void 0}const Q=(i={lat:39.90923,lng:116.397428},m="container")=>{const a=window.qq,P=new a.maps.LatLng(i.lat,i.lng),n=[],{name:e}=L(),y=S({lat:"39.90923",lng:"116.397428",address:"中国北京市北京市东城区西长安街1号"});let c,d;I(()=>{c=new a.maps.Map(document.getElementById(m),{zoom:8,center:P}),d=new a.maps.Marker({position:P,animation:a.maps.MarkerAnimation.DROP,map:c,draggable:!0,visible:!0}),l()});const l=()=>{n.push(a.maps.event.addListener(d,"dragstart",()=>{d.setAnimation(a.maps.MarkerAnimation.UP)})),n.push(a.maps.event.addListener(d,"dragend",s=>{d.setAnimation(a.maps.MarkerAnimation.DOWN),E(s.latLng)}))},u=s=>{c.setCenter(s.location),d.setPosition(s.location),Object.assign(y,s.location),y.address=s.address},E=s=>{const v=new a.maps.Geocoder({complete:function(f){u(f.detail)}});if(C(s,"lat")){const f=new a.maps.LatLng(s.lat,s.lng);v.getAddress(f)}else v.getLocation(s)};return k(e,()=>{typeof c.destroy=="function"&&c.destroy(),n.forEach(s=>{a.maps.event.removeListener(s)}),n.splice(0,n.length)}),{location:y,geocoderFun:E}},M={strokeColor:"#D60000",strokeOpacity:.6,fillOpacity:.1,fillColor:"#D60000",zIndex:99999},b={background:"#fff","font-size":"20px",padding:"5px 10px",border:"1px solid #009CED"},F={enableHighAccuracy:!0,timeout:1e4,position:"RB",offset:[10,20],zoomToAccuracy:!0,GeoLocationFirst:!1},H=(i,m,a)=>{const{name:P}=L();let n;const e={map:void 0,polyEditor:void 0,mouseTool:void 0,placeSearch:void 0,polygons:[],texts:[]},y={fenceCode:"",fenceName:"",fencePath:[],id:0},c=O(!1),d=O(!1),l=S({...y}),u=()=>{var o,t;(o=e.polyEditor)==null||o.close(),(t=e.mouseTool)==null||t.close(!0)},E=()=>new Promise((o,t)=>{G.load({key:"d44819a368d76ea619971a50854f19b9",version:"2.0",plugins:["AMap.PolygonEditor","AMap.Geolocation","AMap.Driving","AMap.MouseTool","AMap.Geolocation","AMap.PlaceSearch"]}).then(p=>{n=p,e.map=new p.Map("map",{center:[116.400274,39.905812],zoom:12}),A(),w(),e.mouseTool=new n.MouseTool(e.map);const g=new n.Geolocation(F);e.map.addControl(g),g.getCurrentPosition((x,r)=>{x=="complete"||m(r)}),e.mouseTool.on("draw",({obj:x})=>{var r;a({msg:"电子围栏绘制完成！",status:"success"}),e.polyEditor=new n.PolygonEditor(e.map,x),e.polyEditor.open(),c.value=!0,(r=e.mouseTool)==null||r.close(!1)}),d.value=!0,o(n)}).catch(p=>{t(p)})}),w=()=>{D(),i.value.forEach((o,t)=>{e.texts.push(new n.Text({position:o.fencePath[0],text:o.fenceName,extData:{id:o.id},style:b}));const p=new n.Polygon;p.setOptions({path:o.fencePath,extData:{id:o.id},...M}),e.polygons.push(p),e.polygons[t].on("click",({target:g})=>{c.value||(u(),e.polyEditor=new n.PolygonEditor(e.map,g),e.polyEditor.open(),Object.assign(l,h(g)))})}),e.map.add([...e.polygons,...e.texts])},s=()=>{var o;u(),Object.assign(l,y),(o=e.mouseTool)==null||o.polygon({...M})},v=o=>{var p,g,x;const t=(p=e.polyEditor)==null?void 0:p.getTarget();if(e.polyEditor&&e.polyEditor.close(),console.log(o,i.value),i.value.some(r=>r.id===o))(x=e.texts.find(r=>r.getExtData().id==l.id))==null||x.setText(l.fenceName),h(t).fencePath=t==null?void 0:t.getPath(),h(t).fenceName=l.fenceName;else{t&&t.destroy();const r=new n.Polygon;r.setOptions({path:t==null?void 0:t.getPath(),extData:{id:o},...M}),e.polygons.push(r),e.texts.push(new n.Text({position:(t==null?void 0:t.getPath())[0],text:l.fenceName,extData:{id:o},style:b})),e.polygons[e.polygons.length-1].on("click",({target:T})=>{c.value||(u(),e.polyEditor=new n.PolygonEditor(e.map,T),e.polyEditor.open(),Object.assign(l,h(T)))}),(g=e.map)==null||g.add([e.polygons[e.polygons.length-1],e.texts[e.texts.length-1]])}c.value=!1},f=o=>{var t;console.log(o,"item"),u(),(t=e.map)==null||t.setFitView([h(o.id)],!1,[60,60,60,60],16)},N=(o,t)=>{o.stopPropagation(),f(t),e.polyEditor=new n.PolygonEditor(e.map,h(t.id)),e.polyEditor.open(),Object.assign(l,t)},z=o=>{u(),e.polygons[o].destroy(),e.texts[o].remove(),i.value.splice(o,1),e.polygons.splice(o,1),e.texts.splice(o,1)},h=o=>C(o,"getExtData")?i.value.find(t=>t.id==o.getExtData().id):e.polygons.find(t=>t&&t.getExtData().id==o),j=(o,t=()=>{})=>{e.placeSearch?e.placeSearch.search(o,t):console.error("placeSearch is not undefined")},q=o=>e[o],A=()=>{e.placeSearch=new n.PlaceSearch({pageSize:5,pageIndex:1,city:"北京",citylimit:!1,map:e.map})},D=()=>{e.polygons.forEach(o=>{o.destroy()}),e.polygons=[],e.texts.forEach(o=>{o.destroy()}),e.texts=[]};return k(P,D),{isInit:d,isDraw:c,currentData:l,get:q,initMap:E,renderData:w,createDraw:s,viewPolygon:f,pushPolygon:v,editPolygon:N,removePolygon:z,findSearch:j,searchInit:A,unmounted:D}};export{H as a,Q as u};
